name: Complete Test Suite

on:
  push:
    branches: [ main, develop, ralph ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-all:
    name: Complete Test Suite
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go-version: ['1.22', '1.23']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Install godog
        run: go install github.com/cucumber/godog/cmd/godog@latest

      - name: Download dependencies
        run: go mod download

      - name: Run all tests
        run: make test-all

      - name: Generate unified coverage report
        if: matrix.go-version == '1.22'
        run: |
          mkdir -p build/coverage
          go test ./... -coverprofile=build/coverage/unit-coverage.out -covermode=count
          go test ./test/functional -coverprofile=build/coverage/functional-coverage.out -covermode=count
          go test ./test/bdd -coverprofile=build/coverage/bdd-coverage.out -covermode=count

          # Merge coverage reports
          echo "mode: count" > build/coverage/merged-coverage.out
          tail -q -n +2 build/coverage/*-coverage.out >> build/coverage/merged-coverage.out

          # Generate HTML report
          go tool cover -html=build/coverage/merged-coverage.out -o build/coverage/merged-coverage.html

          # Calculate total coverage
          TOTAL_COVERAGE=$(go tool cover -func=build/coverage/merged-coverage.out | grep total | awk '{print $3}')
          echo "TOTAL_COVERAGE=$TOTAL_COVERAGE" >> $GITHUB_ENV

      - name: Upload coverage to artifact
        if: matrix.go-version == '1.22'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-go-${{ matrix.go-version }}
          path: build/coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && matrix.go-version == '1.22'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = process.env.TOTAL_COVERAGE;
            const body = `## Test Coverage Report\n\n**Total Coverage:** ${coverage}\n\nFull coverage reports are available in the workflow artifacts.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Test summary
        if: always()
        run: |
          echo "## Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Go Version: ${{ matrix.go-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ matrix.go-version }}" == "1.22" ]; then
            echo "### Coverage" >> $GITHUB_STEP_SUMMARY
            echo "Total Coverage: ${TOTAL_COVERAGE}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Test Types Executed" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Functional Tests" >> $GITHUB_STEP_SUMMARY
          echo "- BDD/ATDD Feature Tests" >> $GITHUB_STEP_SUMMARY
